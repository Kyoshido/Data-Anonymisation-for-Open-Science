## ----setup, include=FALSE-----------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)


## ----eval=FALSE---------------------------------------------------------------------------------------------------------------------------------------------
## # install recordSwapping from github
## devtools::install_github("sdcTools/recordSwapping", build_vignettes = TRUE)
## 
## # install data.table
## # ~ generally good data wrangling package
## install.packages(data.table)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# load package
library(data.table)
library(recordSwapping)


## ----eval=FALSE---------------------------------------------------------------------------------------------------------------------------------------------
## # more detailed explanations/documentation:
## vignette("recordSwapping")
## 
## # documentation of core function
## ?recordSwap()


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat <- fread("SDC Census/test_data_10k.csv.gz")
class(dat) # class data.table


## ---- eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------
## print(dat) # not printed to save space on slide


## ---- eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------
## View(dat)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
head(dat[,.(AGE.M,L001000)],3)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
str(dat[,.(AGE.M,L001000)])


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
colType <- sapply(dat,class)
# filter colnames to non-integer columns
colnames(dat)[colType!="integer"]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# extract X and Y coordinates
dat[,Y_coord:=as.integer(substr(L001000,5,8))]
dat[,X_coord:=as.integer(substr(L001000,10,13))]
dat[1,.(L001000,X_coord,Y_coord)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat[,L001000:=NULL] # drop column


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat[,AGE.M:=as.integer(factor(AGE.M))]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat[,Size:=pmin(5,Size)]
dat[!duplicated(HID),.N,by=.(Size)][order(Size)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# geographic hierarchy 
# read from left to right
# NUTS1 > NUTS2 > ...
hierarchy <- c("NUTS1","NUTS2")

# hid column
hid <- "HID"


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# risk variables
risk_variables <- c("COC.M","POB.M")
k_anonymity <- 3


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
swaprate <- 0.05
similar <- "Size"
seed <- 2021681


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_swapped <- recordSwap(data = dat, hid = hid,
                          hierarchy = hierarchy,
                          similar = similar,
                          risk_variables = risk_variables,
                          k_anonymity = k_anonymity,
                          swaprate = swaprate,
                          return_swapped_id = TRUE,
                          seed = seed)


dat_swapped[,table(NUTS1,SEX)]

## ---- eval=FALSE--------------------------------------------------------------------------------------------------------------------------------------------
## View(dat_swapped)
## print(dat_swapped)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_swapped[HID!=HID_swapped,uniqueN(HID)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# original data
dat[,table(NUTS1,COC.L)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# swapped data
dat_swapped[,table(NUTS1,COC.L)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
tab_vars <- c("NUTS2","SEX","AGE.M","COC.H")
tab1 <- dat[,.(N1=.N),by=c(tab_vars)]
tab2 <- dat_swapped[,.(N2=.N),by=c(tab_vars)]

tab <- merge(tab1,tab2, all=TRUE)
tab[is.na(N1),N1:=0]
tab[is.na(N2),N2:=0]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# mean absolute deviation
ad <- tab[,mean(abs(N1-N2)),by=.(NUTS2)]
ad


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
ad[,mean(V1)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# aggregate NUTS2, SEX and AGE.M
rad <- tab[,.(N1=sum(N1),N2=sum(N2)),by=.(NUTS2,SEX,AGE.M)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# RAD by NUTS2
rad <- rad[,sum(abs(N1-N2)/N1),by=.(NUTS2)]
# take average
rad[,mean(V1)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
# hellingers distance
hd <- tab[,sqrt(1/2*sum((sqrt(N1)-sqrt(N2))^2)),
                 by=.(NUTS2)]
hd[,mean(V1)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
tab[,sum(N1<3&N2==N1)/sum(N1<3)]


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
similar <- c("Size","HST")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_swapped2 <- recordSwap(data = dat, hid = hid,
                          hierarchy = hierarchy,
                          similar = similar,
                          risk_variables = risk_variables,
                          k_anonymity = k_anonymity,
                          swaprate = swaprate,
                          return_swapped_id = TRUE,
                          seed = seed)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_tph <- unique(dat[,.(HID_swapped=HID,HST_swapped=HST)])
dat_swapped[dat_tph,HST_swapped:=HST_swapped,on=.(HID_swapped)]

select_vars <- c("NUTS1", "NUTS2", "HID", "HID_swapped",
                 "Size", "HST", "HST_swapped")

head(dat_swapped[!duplicated(HID)][HST!=HST_swapped,..select_vars],4)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
similar <- c("Size","HST")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_swapped2 <- recordSwap(data = dat, hid = hid,
                          hierarchy = hierarchy,
                          similar = similar,
                          risk_variables = risk_variables,
                          k_anonymity = k_anonymity,
                          swaprate = swaprate,
                          return_swapped_id = TRUE,
                          seed = seed)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_tph <- unique(dat[,.(HID_swapped=HID,HST_swapped=HST)])
dat_swapped2[dat_tph,HST_swapped:=HST_swapped,on=.(HID_swapped)]

select_vars <- c("NUTS1", "NUTS2", "HID", "HID_swapped",
                 "Size", "HST", "HST_swapped")


# HST identical for every swap
dat_swapped2[,all(HST==HST_swapped)]


## ---- include=FALSE-----------------------------------------------------------------------------------------------------------------------------------------
similar <- c("Size")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
hids_swapped <- dat_swapped[HID!=HID_swapped]
head(hids_swapped[!duplicated(HID),.(NUTS1,NUTS2,NUTS3,LAU2)],4)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
carry_along <- c("NUTS3","LAU2","X_coord","Y_coord")


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
dat_swapped3 <- recordSwap(data = dat, hid = hid,
                          hierarchy = hierarchy,
                          similar = similar,
                          risk_variables = risk_variables,
                          k_anonymity = k_anonymity,
                          swaprate = swaprate,
                          carry_along = carry_along,
                          return_swapped_id = TRUE,
                          seed = seed)


## -----------------------------------------------------------------------------------------------------------------------------------------------------------
hids_swapped <- dat_swapped[HID!=HID_swapped]
head(hids_swapped[!duplicated(HID),.(NUTS1,NUTS2,NUTS3,LAU2)])

